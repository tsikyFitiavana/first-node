{"ast":null,"code":"var _ = require('lodash');\n\nvar httpProxy = require('http-proxy');\n\nvar configFactory = require('./config-factory');\n\nvar handlers = require('./handlers');\n\nvar contextMatcher = require('./context-matcher');\n\nvar PathRewriter = require('./path-rewriter');\n\nvar Router = require('./router');\n\nvar logger = require('./logger').getInstance();\n\nvar getArrow = require('./logger').getArrow;\n\nmodule.exports = HttpProxyMiddleware;\n\nfunction HttpProxyMiddleware(context, opts) {\n  // https://github.com/chimurai/http-proxy-middleware/issues/57\n  var wsUpgradeDebounced = _.debounce(handleUpgrade);\n\n  var wsInitialized = false;\n  var config = configFactory.createConfig(context, opts);\n  var proxyOptions = config.options; // create proxy\n\n  var proxy = httpProxy.createProxyServer({});\n  logger.info('[HPM] Proxy created:', config.context, ' -> ', proxyOptions.target);\n  var pathRewriter = PathRewriter.create(proxyOptions.pathRewrite); // returns undefined when \"pathRewrite\" is not provided\n  // attach handler to http-proxy events\n\n  handlers.init(proxy, proxyOptions); // log errors for debug purpose\n\n  proxy.on('error', logError); // https://github.com/chimurai/http-proxy-middleware/issues/19\n  // expose function to upgrade externally\n\n  middleware.upgrade = wsUpgradeDebounced;\n  return middleware;\n\n  function middleware(req, res, next) {\n    if (shouldProxy(config.context, req)) {\n      var activeProxyOptions = prepareProxyRequest(req);\n      proxy.web(req, res, activeProxyOptions);\n    } else {\n      next();\n    }\n\n    if (proxyOptions.ws === true) {\n      // use initial request to access the server object to subscribe to http upgrade event\n      catchUpgradeRequest(req.connection.server);\n    }\n  }\n\n  function catchUpgradeRequest(server) {\n    // subscribe once; don't subscribe on every request...\n    // https://github.com/chimurai/http-proxy-middleware/issues/113\n    if (!wsInitialized) {\n      server.on('upgrade', wsUpgradeDebounced);\n      wsInitialized = true;\n    }\n  }\n\n  function handleUpgrade(req, socket, head) {\n    // set to initialized when used externally\n    wsInitialized = true;\n\n    if (shouldProxy(config.context, req)) {\n      var activeProxyOptions = prepareProxyRequest(req);\n      proxy.ws(req, socket, head, activeProxyOptions);\n      logger.info('[HPM] Upgrading to WebSocket');\n    }\n  }\n  /**\n   * Determine whether request should be proxied.\n   *\n   * @private\n   * @param  {String} context [description]\n   * @param  {Object} req     [description]\n   * @return {Boolean}\n   */\n\n\n  function shouldProxy(context, req) {\n    var path = req.originalUrl || req.url;\n    return contextMatcher.match(context, path, req);\n  }\n  /**\n   * Apply option.router and option.pathRewrite\n   * Order matters:\n   *    Router uses original path for routing;\n   *    NOT the modified path, after it has been rewritten by pathRewrite\n   * @param {Object} req\n   * @return {Object} proxy options\n   */\n\n\n  function prepareProxyRequest(req) {\n    // https://github.com/chimurai/http-proxy-middleware/issues/17\n    // https://github.com/chimurai/http-proxy-middleware/issues/94\n    req.url = req.originalUrl || req.url; // store uri before it gets rewritten for logging\n\n    var originalPath = req.url;\n\n    var newProxyOptions = _.assign({}, proxyOptions); // Apply in order:\n    // 1. option.router\n    // 2. option.pathRewrite\n\n\n    __applyRouter(req, newProxyOptions);\n\n    __applyPathRewrite(req, pathRewriter); // debug logging for both http(s) and websockets\n\n\n    if (proxyOptions.logLevel === 'debug') {\n      var arrow = getArrow(originalPath, req.url, proxyOptions.target, newProxyOptions.target);\n      logger.debug('[HPM] %s %s %s %s', req.method, originalPath, arrow, newProxyOptions.target);\n    }\n\n    return newProxyOptions;\n  } // Modify option.target when router present.\n\n\n  function __applyRouter(req, options) {\n    var newTarget;\n\n    if (options.router) {\n      newTarget = Router.getTarget(req, options);\n\n      if (newTarget) {\n        logger.debug('[HPM] Router new target: %s -> \"%s\"', options.target, newTarget);\n        options.target = newTarget;\n      }\n    }\n  } // rewrite path\n\n\n  function __applyPathRewrite(req, pathRewriter) {\n    if (pathRewriter) {\n      var path = pathRewriter(req.url, req);\n\n      if (typeof path === 'string') {\n        req.url = path;\n      } else {\n        logger.info('[HPM] pathRewrite: No rewritten path found. (%s)', req.url);\n      }\n    }\n  }\n\n  function logError(err, req, res) {\n    var hostname = req.headers && req.headers.host || req.hostname || req.host; // (websocket) || (node0.10 || node 4/5)\n\n    var target = proxyOptions.target.host || proxyOptions.target;\n    var errorMessage = '[HPM] Error occurred while trying to proxy request %s from %s to %s (%s) (%s)';\n    var errReference = 'https://nodejs.org/api/errors.html#errors_common_system_errors'; // link to Node Common Systems Errors page\n\n    logger.error(errorMessage, req.url, hostname, target, err.code || err, errReference);\n  }\n}","map":null,"metadata":{},"sourceType":"script"}