{"ast":null,"code":"var _ = require('lodash');\n\nvar logger = require('./logger').getInstance();\n\nmodule.exports = {\n  init: init,\n  getHandlers: getProxyEventHandlers\n};\n\nfunction init(proxy, opts) {\n  var handlers = getProxyEventHandlers(opts);\n\n  _.forIn(handlers, function (handler, eventName) {\n    proxy.on(eventName, handlers[eventName]);\n  });\n\n  logger.debug('[HPM] Subscribed to http-proxy events: ', _.keys(handlers));\n}\n\nfunction getProxyEventHandlers(opts) {\n  // https://github.com/nodejitsu/node-http-proxy#listening-for-proxy-events\n  var proxyEvents = ['error', 'proxyReq', 'proxyReqWs', 'proxyRes', 'open', 'close'];\n  var handlers = {};\n\n  _.forEach(proxyEvents, function (event) {\n    // all handlers for the http-proxy events are prefixed with 'on'.\n    // loop through options and try to find these handlers\n    // and add them to the handlers object for subscription in init().\n    var eventName = _.camelCase('on ' + event);\n\n    var fnHandler = _.get(opts, eventName);\n\n    if (_.isFunction(fnHandler)) {\n      handlers[event] = fnHandler;\n    }\n  }); // add default error handler in absence of error handler\n\n\n  if (!_.isFunction(handlers.error)) {\n    handlers.error = defaultErrorHandler;\n  } // add default close handler in absence of close handler\n\n\n  if (!_.isFunction(handlers.close)) {\n    handlers.close = logClose;\n  }\n\n  return handlers;\n}\n\nfunction defaultErrorHandler(err, req, res) {\n  var host = req.headers && req.headers.host;\n  var code = err.code;\n\n  if (res.writeHead && !res.headersSent) {\n    if (/HPE_INVALID/.test(code)) {\n      res.writeHead(502);\n    } else {\n      switch (code) {\n        case 'ECONNRESET':\n        case 'ENOTFOUND':\n        case 'ECONNREFUSED':\n          res.writeHead(504);\n          break;\n\n        default:\n          res.writeHead(500);\n      }\n    }\n  }\n\n  res.end('Error occured while trying to proxy to: ' + host + req.url);\n}\n\nfunction logClose(req, socket, head) {\n  // view disconnected websocket connections\n  logger.info('[HPM] Client disconnected');\n}","map":null,"metadata":{},"sourceType":"script"}